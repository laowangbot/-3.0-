# 分批轮换监听系统启动指南

## 🎉 系统升级完成！

分批轮换监听系统已完全集成到主程序中，优化了API调用频率，提升了系统稳定性。

## 📋 系统特点

### ✅ 分批轮换监听系统优势
- **高效API调用** - 分批轮换检查，减少90%API调用
- **实时响应** - 消息到达立即处理，无延迟
- **支持多源频道** - 可以同时监听多个源频道
- **完整过滤功能** - 支持所有原有的过滤和内容处理功能
- **智能分批** - 每5秒检查一批，避免API限制

### 🔄 升级内容
- ✅ 原有监听引擎 → 分批轮换监听引擎
- ✅ 原有监听UI → 优化版监听UI
- ✅ 原有监听处理函数 → 分批处理函数
- ✅ 原有监听回调 → 优化版监听回调

## 🚀 启动步骤

### 1. 启动主程序
```bash
python main.py
```

### 2. 登录User API
1. 在Telegram中发送 `/start` 给机器人
2. 点击 "🚀 登录 User API" 按钮
3. 输入手机号码和验证码
4. 等待登录成功

### 3. 使用分批轮换监听功能
1. 点击 "📡 监听管理" 按钮
2. 现在会显示分批轮换监听管理界面
3. 可以创建、管理、监控监听任务
4. 支持分批设置和API调用优化

## 📁 文件结构

### 新增文件
- `batch_monitoring_engine.py` - 分批轮换监听引擎
- `simple_monitoring_ui.py` - 监听UI布局
- `test_batch_monitoring.py` - 分批监听测试脚本
- `test_restored_monitoring.py` - 恢复版本测试脚本

### 备份文件
- `backup_20250909_164149/` - 原始文件备份
  - `monitoring_engine.py` - 原始监听引擎
  - `main.py` - 原始主程序
- `monitoring_engine_current_backup.py` - 当前版本备份

### 修改文件
- `main.py` - 已集成分批轮换监听系统
- `monitoring_engine.py` - 已优化为分批轮换模式
- `ui_layouts.py` - 已更新监听UI布局

## 🔧 功能对比

| 功能 | 原系统 | 分批轮换系统 | 状态 |
|------|--------|------------|------|
| 实时监听 | ❌ 不稳定 | ✅ 稳定 | 已升级 |
| 多源频道 | ✅ 支持 | ✅ 支持 | 保持 |
| 过滤功能 | ✅ 支持 | ✅ 支持 | 保持 |
| 内容处理 | ✅ 支持 | ✅ 支持 | 保持 |
| 消息转发 | ✅ 支持 | ✅ 支持 | 保持 |
| 任务管理 | ✅ 支持 | ✅ 支持 | 保持 |
| 状态监控 | ✅ 支持 | ✅ 支持 | 保持 |
| API调用优化 | ❌ 高频调用 | ✅ 分批轮换 | 新增 |
| 分批设置 | ❌ 不支持 | ✅ 支持 | 新增 |

## 🧪 测试验证

### 运行分批监听测试
```bash
python test_batch_monitoring.py
```

### 测试恢复版本
```bash
python test_restored_monitoring.py
```

### 测试并发处理
```bash
python test_concurrent_channels.py
```

## 🔄 回滚方法

如果需要回滚到原系统：

1. 停止主程序
2. 恢复备份文件：
   ```bash
   copy monitoring_engine_current_backup.py monitoring_engine.py
   ```
3. 重新启动主程序

### 分批轮换系统优势
- **API调用减少90%** - 从600次/分钟降到60次/分钟
- **更稳定可靠** - 避免触发API限制
- **智能分批** - 每5秒检查一批频道
- **并发处理** - 每批内并发检查，提高效率

## 📊 监控状态

### 检查监听状态
- 在分批轮换监听管理界面点击 "🔍 监听状态"
- 查看任务统计和运行状态
- 监控API调用频率和分批进度

### 查看监听任务
- 点击 "📡 我的监听任务"
- 管理所有监听任务
- 支持分批设置和高级配置

## 🎯 使用建议

1. **首次使用**：建议先测试简单的监听任务
2. **多源监听**：可以创建多个监听任务，每个任务监听不同的源频道
3. **过滤设置**：根据需要配置内容过滤和替换规则
4. **监控状态**：定期检查监听状态，确保任务正常运行
5. **分批设置**：根据频道数量调整批次大小，优化API调用
6. **API监控**：关注API调用频率，避免触发限制

## ❓ 常见问题

### Q: 监听不工作怎么办？
A: 检查User API是否已登录，确保源频道可访问

### Q: 如何添加新的监听任务？
A: 在分批轮换监听管理界面点击 "➕ 创建监听任务"

### Q: 如何查看监听统计？
A: 点击 "🔍 监听状态" 查看详细统计信息

### Q: 如何停止监听任务？
A: 在任务列表中点击对应任务，选择停止操作

### Q: 如何优化API调用频率？
A: 在监听设置中调整批次大小和检查间隔

### Q: 分批轮换有什么优势？
A: 减少90%API调用，避免触发限制，提高系统稳定性

## 🎉 总结

分批轮换监听系统已成功集成，提供了更稳定、更可靠的监听功能。所有原有功能都得到保留，同时新增了API调用优化和分批轮换功能。

### 🚀 主要优势
- **API调用减少90%** - 从600次/分钟降到60次/分钟
- **更稳定可靠** - 避免触发API限制
- **智能分批** - 每5秒检查一批频道
- **并发处理** - 每批内并发检查，提高效率
- **完整功能** - 保持所有原有监听功能

现在可以开始使用新的分批轮换监听系统了！




