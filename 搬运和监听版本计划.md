# æ¬è¿å’Œç›‘å¬ç‰ˆæœ¬è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å®Œå…¨é‡æ„æœºå™¨äººæµç¨‹ï¼Œæ”¾å¼ƒé¢‘é“ç»„æ¨¡å¼ï¼Œæ”¹ä¸ºåŸºäºç®¡ç†å‘˜é¢‘é“çš„ç®¡ç†æ¨¡å¼ï¼Œå¹¶å¢åŠ å®æ—¶ç›‘å¬åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. æ–°æµç¨‹æ¶æ„

**å®Œå…¨æ”¾å¼ƒé¢‘é“ç»„æµç¨‹**
- ä¸å†ä½¿ç”¨é¢‘é“ç»„é…å¯¹æ¨¡å¼
- æ”¹ä¸º"æˆ‘çš„é¢‘é“"ç®¡ç†æ¨¡å¼
- æ¯ä¸ªé¢‘é“ç‹¬ç«‹é…ç½®å’Œæ¬è¿

**æ–°çš„æ•°æ®å­˜å‚¨ç»“æ„**
```python
ç”¨æˆ·é…ç½®:
â”œâ”€â”€ admin_channels: [é¢‘é“åˆ—è¡¨]
â”‚   â”œâ”€â”€ channel_id: -1001234567890
â”‚   â”œâ”€â”€ channel_name: "æˆ‘çš„é¢‘é“1"
â”‚   â”œâ”€â”€ channel_type: "public/private"
â”‚   â”œâ”€â”€ admin_since: "2025-01-02 20:30:00"
â”‚   â””â”€â”€ filter_config: {è¿‡æ»¤é…ç½®}
â””â”€â”€ cloning_sessions: [æ¬è¿ä¼šè¯]
    â”œâ”€â”€ session_id: "session_123"
    â”œâ”€â”€ target_channel: -1001234567890
    â”œâ”€â”€ source_channels: [
    â”‚   â”œâ”€â”€ {channel_id: -1001111111111, message_range: "100-200"}
    â”‚   â””â”€â”€ {channel_id: -1002222222222, message_range: "300-400"}
    â”‚   ]
    â””â”€â”€ status: "pending/running/completed"
```

### 2. ç›‘å¬åŠŸèƒ½

**ç›‘å¬ä»»åŠ¡ç»“æ„**
```python
class MonitoringTask:
    session_id: str
    user_id: str
    target_channel: str
    source_channels: List[Dict]  # æ¯ä¸ªæºé¢‘é“çš„æœ€åæ¶ˆæ¯ID
    monitoring_interval: int = 60  # ç§’
    is_active: bool = True
    last_check_time: datetime
    next_check_time: datetime
```

**ç›‘å¬æ•°æ®å­˜å‚¨**
```python
monitoring_tasks: {
    "user_123": {
        "task_456": {
            "target_channel": "-1001234567890",
            "source_channels": [
                {
                    "channel_id": "-1001111111111",
                    "channel_username": "@source1",
                    "last_message_id": 1500,
                    "check_interval": 60,
                    "next_check": "2025-01-02 20:35:00"
                },
                {
                    "channel_id": "-1002222222222", 
                    "channel_username": "@source2",
                    "last_message_id": 2300,
                    "check_interval": 120,  # é”™å¼€æ—¶é—´
                    "next_check": "2025-01-02 20:36:00"
                }
            ],
            "status": "active"
        }
    }
}
```

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®å±‚æ”¹é€ 

**æ–°çš„æ•°æ®ç®¡ç†æ–¹æ³•**
```python
class LocalDataManager:
    async def get_admin_channels(self, user_id: str) -> List[Dict]
    async def update_channel_filter_config(self, user_id: str, channel_id: str, config: Dict)
    async def create_cloning_session(self, user_id: str, session_data: Dict)
    async def get_cloning_sessions(self, user_id: str) -> List[Dict]
    async def create_monitoring_task(self, user_id: str, task_data: Dict)
    async def get_monitoring_tasks(self, user_id: str) -> List[Dict]
    async def update_monitoring_task(self, user_id: str, task_id: str, updates: Dict)
```

### 2. ç›‘å¬å¼•æ“

**æ ¸å¿ƒç›‘å¬å¼•æ“**
```python
class MonitoringEngine:
    async def start_monitoring(self, task: MonitoringTask)
    async def check_channel_updates(self, channel_info: Dict) -> List[Message]
    async def process_new_messages(self, messages: List[Message], target_channel: str)
    async def update_last_message_id(self, channel_id: str, message_id: int)
    async def schedule_next_check(self, task: MonitoringTask)
    async def stop_monitoring(self, task_id: str)
    async def pause_monitoring(self, task_id: str)
    async def resume_monitoring(self, task_id: str)
```

**APIé™åˆ¶å¤„ç†**
```python
class APIRateLimiter:
    def __init__(self):
        self.last_request_time = {}
        self.min_interval = 1  # æœ€å°é—´éš”1ç§’
    
    async def wait_if_needed(self, channel_id: str):
        if channel_id in self.last_request_time:
            elapsed = time.time() - self.last_request_time[channel_id]
            if elapsed < self.min_interval:
                await asyncio.sleep(self.min_interval - elapsed)
        self.last_request_time[channel_id] = time.time()
```

**æ—¶é—´é”™å¼€ç­–ç•¥**
```python
def calculate_check_intervals(channels: List[str]) -> Dict[str, int]:
    base_interval = 60  # åŸºç¡€é—´éš”60ç§’
    intervals = {}
    for i, channel in enumerate(channels):
        intervals[channel] = base_interval + (i * 10)  # æ¯ä¸ªé¢‘é“é”™å¼€10ç§’
    return intervals
```

### 3. æƒé™æ£€æµ‹

**ç®¡ç†å‘˜é¢‘é“æ£€æµ‹**
```python
async def _detect_admin_channels(self, user_id: str) -> List[Dict]
async def _check_channel_admin_status(self, channel_id: str) -> bool
async def _get_channel_permissions(self, channel_id: str) -> Dict
async def _update_admin_channels_list(self, user_id: str)
```

## ğŸ® ç”¨æˆ·ç•Œé¢æµç¨‹

### 1. æ–°çš„UIæµç¨‹

**ä¸»èœå•ç»“æ„**
```
ä¸»èœå•
â”œâ”€â”€ ğŸ“¡ æˆ‘çš„é¢‘é“ (æ˜¾ç¤ºç®¡ç†å‘˜é¢‘é“åˆ—è¡¨)
â”‚   â”œâ”€â”€ é¢‘é“1 [é…ç½®] [æ¬è¿] [ç›‘å¬]
â”‚   â”œâ”€â”€ é¢‘é“2 [é…ç½®] [æ¬è¿] [ç›‘å¬]
â”‚   â””â”€â”€ é¢‘é“3 [é…ç½®] [æ¬è¿] [ç›‘å¬]
â”œâ”€â”€ âš™ï¸ å…¨å±€è®¾ç½®
â”œâ”€â”€ ğŸ“Š ä»»åŠ¡çŠ¶æ€
â””â”€â”€ ğŸ” ç›‘å¬ç®¡ç†
```

**æ¬è¿æµç¨‹**
```
é€‰æ‹©ç›®æ ‡é¢‘é“ â†’ è¾“å…¥æºé¢‘é“+IDæ®µ â†’ æ·»åŠ æ›´å¤šæº â†’ å¼€å§‹æ¬è¿
```

**ç›‘å¬è®¾ç½®æµç¨‹**
```
é€‰æ‹©ç›®æ ‡é¢‘é“ â†’ è®¾ç½®ç›‘å¬ â†’ è¾“å…¥æºé¢‘é“ â†’ è¾“å…¥æœ€åæ¶ˆæ¯ID â†’ ç¡®è®¤è®¾ç½®
```

### 2. ç›‘å¬ç®¡ç†ç•Œé¢

**ç›‘å¬ä»»åŠ¡ç®¡ç†**
```
ğŸ“¡ ç›‘å¬ä»»åŠ¡ç®¡ç†

âœ… ä»»åŠ¡1: æˆ‘çš„é¢‘é“1
   ğŸ“¡ ç›‘å¬: @source1 (æœ€åID: 1500)
   ğŸ“¡ ç›‘å¬: @source2 (æœ€åID: 2300)
   â° ä¸‹æ¬¡æ£€æŸ¥: 20:35:00
   [æš‚åœ] [ç¼–è¾‘] [åˆ é™¤]

âœ… ä»»åŠ¡2: æˆ‘çš„é¢‘é“2
   ğŸ“¡ ç›‘å¬: @source3 (æœ€åID: 800)
   â° ä¸‹æ¬¡æ£€æŸ¥: 20:36:00
   [æš‚åœ] [ç¼–è¾‘] [åˆ é™¤]
```

## âš¡ é«˜çº§åŠŸèƒ½

### 1. æ™ºèƒ½ç›‘å¬

**æ™ºèƒ½æ£€æŸ¥é¢‘ç‡**
```python
def calculate_optimal_interval(self, channel_activity: Dict) -> int:
    # æ ¹æ®é¢‘é“æ´»è·ƒåº¦è°ƒæ•´æ£€æŸ¥é¢‘ç‡
    if channel_activity.get('high_activity', False):
        return 30  # é«˜æ´»è·ƒé¢‘é“30ç§’æ£€æŸ¥ä¸€æ¬¡
    elif channel_activity.get('medium_activity', False):
        return 60  # ä¸­ç­‰æ´»è·ƒé¢‘é“60ç§’æ£€æŸ¥ä¸€æ¬¡
    else:
        return 120  # ä½æ´»è·ƒé¢‘é“120ç§’æ£€æŸ¥ä¸€æ¬¡
```

**æ¶ˆæ¯è·å–ç­–ç•¥**
```python
async def get_new_messages(self, channel_id: str, last_message_id: int) -> List[Message]:
    try:
        # è·å–é¢‘é“æœ€æ–°æ¶ˆæ¯
        messages = await self.client.get_messages(
            entity=channel_id,
            limit=100,  # æ¯æ¬¡æœ€å¤šè·å–100æ¡
            min_id=last_message_id
        )
        return messages
    except Exception as e:
        logger.error(f"è·å–é¢‘é“æ¶ˆæ¯å¤±è´¥: {e}")
        return []
```

### 2. é”™è¯¯å¤„ç†ä¸é‡è¯•

**å¥å£®çš„é¢‘é“æ£€æŸ¥**
```python
async def robust_channel_check(self, channel_info: Dict, max_retries: int = 3):
    for attempt in range(max_retries):
        try:
            return await self.check_channel_updates(channel_info)
        except FloodWaitError as e:
            logger.warning(f"APIé™åˆ¶ï¼Œç­‰å¾…{e.value}ç§’")
            await asyncio.sleep(e.value)
        except Exception as e:
            logger.error(f"æ£€æŸ¥é¢‘é“å¤±è´¥ (å°è¯•{attempt+1}/{max_retries}): {e}")
            if attempt < max_retries - 1:
                await asyncio.sleep(5 * (attempt + 1))  # æŒ‡æ•°é€€é¿
    return []
```

### 3. æ‰¹é‡å¤„ç†

**å¤šæ¶ˆæ¯æ‰¹é‡æ¬è¿**
- å¤šä¸ªæ–°æ¶ˆæ¯æ‰¹é‡æ¬è¿
- ä¿æŒæ¶ˆæ¯çš„æ—¶é—´é¡ºåº
- é¿å…é‡å¤æ¬è¿

## ğŸ“Š å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šæ•°æ®å±‚æ”¹é€ 
- [ ] ä¿®æ”¹æ•°æ®å­˜å‚¨ç»“æ„
- [ ] å®ç°æ–°çš„æ•°æ®ç®¡ç†æ–¹æ³•
- [ ] æ•°æ®è¿ç§»è„šæœ¬
- [ ] æµ‹è¯•æ•°æ®å±‚åŠŸèƒ½

### é˜¶æ®µ2ï¼šæƒé™æ£€æµ‹
- [ ] å®ç°ç®¡ç†å‘˜é¢‘é“æ£€æµ‹
- [ ] æƒé™çŠ¶æ€ç›‘æ§
- [ ] è‡ªåŠ¨æ›´æ–°æœºåˆ¶
- [ ] æƒé™éªŒè¯åŠŸèƒ½

### é˜¶æ®µ3ï¼šUIé‡æ„
- [ ] æ–°çš„é¢‘é“ç®¡ç†ç•Œé¢
- [ ] å¤šæºé¢‘é“è¾“å…¥æµç¨‹
- [ ] æ¬è¿ä¼šè¯ç®¡ç†
- [ ] ç›‘å¬ä»»åŠ¡ç®¡ç†ç•Œé¢

### é˜¶æ®µ4ï¼šç›‘å¬å¼•æ“
- [ ] å®ç°ç›‘å¬å¼•æ“æ ¸å¿ƒ
- [ ] APIé™åˆ¶å¤„ç†
- [ ] æ™ºèƒ½é¢‘ç‡è°ƒæ•´
- [ ] é”™è¯¯å¤„ç†ä¸é‡è¯•

### é˜¶æ®µ5ï¼šæ¬è¿å¼•æ“é€‚é…
- [ ] é€‚é…æ–°çš„æ•°æ®æ ¼å¼
- [ ] å¤šæºé¢‘é“å¤„ç†é€»è¾‘
- [ ] ä¼šè¯çŠ¶æ€ç®¡ç†
- [ ] æ€§èƒ½ä¼˜åŒ–

### é˜¶æ®µ6ï¼šæµ‹è¯•ä¸ä¼˜åŒ–
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡
- **æ“ä½œæ›´ç›´è§‚**: ç›´æ¥çœ‹åˆ°è‡ªå·±çš„é¢‘é“ï¼Œæ— éœ€å¤æ‚çš„é¢‘é“ç»„é…ç½®
- **é…ç½®æ›´çµæ´»**: æ¯ä¸ªé¢‘é“ç‹¬ç«‹é…ç½®ï¼Œæ”¯æŒä¸åŒçš„è¿‡æ»¤è§„åˆ™
- **ç®¡ç†æ›´ç®€å•**: è‡ªåŠ¨æ£€æµ‹ç®¡ç†å‘˜çŠ¶æ€ï¼Œå‡å°‘æ‰‹åŠ¨é…ç½®
- **è‡ªåŠ¨åŒ–ç¨‹åº¦æ›´é«˜**: å®æ—¶ç›‘å¬åŠŸèƒ½ï¼Œæ— éœ€æ‰‹åŠ¨è§¦å‘æ¬è¿

### åŠŸèƒ½å¢å¼º
- **å¤šæºé¢‘é“æ”¯æŒ**: ä¸€æ¬¡å¯ä»¥è¾“å…¥å¤šä¸ªæºé¢‘é“ï¼Œæ¯ä¸ªè®¾ç½®ä¸åŒçš„æ¶ˆæ¯IDæ®µ
- **å®æ—¶ç›‘å¬åŠŸèƒ½**: è‡ªåŠ¨å‘ç°æ–°æ¶ˆæ¯å¹¶æ¬è¿ï¼Œæ”¯æŒå…¬å…±é¢‘é“ç›‘å¬
- **æ™ºèƒ½æƒé™æ£€æµ‹**: å®æ—¶æ£€æµ‹æœºå™¨äººç®¡ç†å‘˜çŠ¶æ€
- **è‡ªåŠ¨é”™è¯¯æ¢å¤**: æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œè‡ªåŠ¨å¤„ç†å„ç§é”™è¯¯æƒ…å†µ

### ç»´æŠ¤ç®€åŒ–
- **è‡ªåŠ¨çŠ¶æ€åŒæ­¥**: ç›‘å¬ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨æ›´æ–°
- **å‡å°‘æ‰‹åŠ¨æ“ä½œ**: æ™ºèƒ½é…ç½®ç®¡ç†ï¼Œè‡ªåŠ¨ä¼˜åŒ–æ£€æŸ¥é¢‘ç‡
- **æ™ºèƒ½é…ç½®ç®¡ç†**: æ ¹æ®é¢‘é“æ´»è·ƒåº¦è‡ªåŠ¨è°ƒæ•´å‚æ•°
- **å®Œå–„çš„ç›‘æ§æœºåˆ¶**: è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯å’Œé”™è¯¯æ—¥å¿—

## âš ï¸ æ³¨æ„äº‹é¡¹

### APIé™åˆ¶
- Telegram APIæœ‰ä¸¥æ ¼çš„é¢‘ç‡é™åˆ¶
- éœ€è¦åˆç†åˆ†é…æ£€æŸ¥æ—¶é—´
- å®ç°æ™ºèƒ½é€€é¿ç­–ç•¥

### èµ„æºæ¶ˆè€—
- é•¿æ—¶é—´è¿è¡Œçš„å†…å­˜å ç”¨
- ç½‘ç»œè¿æ¥ç®¡ç†
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### é”™è¯¯æ¢å¤
- æœºå™¨äººé‡å¯åçš„ä»»åŠ¡æ¢å¤
- ç½‘ç»œä¸­æ–­çš„è‡ªåŠ¨é‡è¿
- æ•°æ®ä¸€è‡´æ€§ä¿è¯

### éšç§è€ƒè™‘
- åªæ˜¾ç¤ºæœºå™¨äººè‡ªå·±çš„æƒé™
- ä¸æ˜¾ç¤ºå…¶ä»–ç®¡ç†å‘˜ä¿¡æ¯
- ä¿æŠ¤ç”¨æˆ·éšç§æ•°æ®

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### 1. æƒé™æ£€æŸ¥
- æ£€æŸ¥ç‰¹å®šé¢‘é“çš„ç®¡ç†å‘˜æƒé™
- å¯¹æ¯”ä¸åŒé¢‘é“çš„æƒé™å·®å¼‚
- æƒé™ä¸è¶³æ—¶æé†’ç”¨æˆ·

### 2. è‡ªåŠ¨ä¿®å¤
- æä¾›æƒé™é—®é¢˜çš„è§£å†³å»ºè®®
- è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤é…ç½®é—®é¢˜
- æ™ºèƒ½é”™è¯¯è¯Šæ–­

### 3. ç›‘æ§ç»Ÿè®¡
- ç›‘å¬ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡
- æ–°æ¶ˆæ¯å‘ç°ç»Ÿè®¡
- æ¬è¿æˆåŠŸç‡ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§

### 4. é«˜çº§é…ç½®
- è‡ªå®šä¹‰ç›‘å¬é¢‘ç‡
- æ™ºèƒ½è¿‡æ»¤è§„åˆ™
- æ‰¹é‡æ“ä½œæ”¯æŒ
- ä»»åŠ¡æ¨¡æ¿åŠŸèƒ½

---

**åˆ›å»ºæ—¶é—´**: 2025-01-02  
**ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: è®¡åˆ’é˜¶æ®µ  
**ä¼˜å…ˆçº§**: é«˜
