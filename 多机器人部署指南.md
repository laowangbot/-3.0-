# 🤖 多机器人部署指南

## 📋 概述

本指南将帮助您在同一台服务器上部署多个Telegram搬运机器人，每个机器人都有独立的配置和session文件，避免冲突。

## 🚨 问题说明

### **为什么需要多机器人支持？**

1. **Session文件冲突**: 多个机器人使用相同的session文件名会导致锁定
2. **配置冲突**: 所有机器人共享同一个配置文件
3. **数据混乱**: 不同机器人的数据可能相互干扰

### **解决方案**

- ✅ 每个机器人使用独立的session文件
- ✅ 每个机器人有独立的配置文件
- ✅ 支持命令行参数指定机器人
- ✅ 自动生成唯一的session文件名

## 🛠️ 设置步骤

### **1. 初始化多机器人环境**

```bash
python main.py --setup
```

这将创建 `bot_configs` 目录和示例配置文件。

### **2. 创建机器人配置**

```bash
# 创建名为 "my_bot_1" 的机器人配置
python main.py --create-bot my_bot_1

# 创建名为 "my_bot_2" 的机器人配置  
python main.py --create-bot my_bot_2
```

这将同时创建JSON配置文件和.env环境文件。

### **3. 编辑环境配置文件**

**本地部署**: 编辑 `.env.my_bot_1`:

```bash
# ==================== 机器人 my_bot_1 环境配置 ====================
# Telegram Bot配置
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
API_ID=12345678
API_HASH=abcdef1234567890abcdef1234567890

# Firebase配置
FIREBASE_PROJECT_ID=your_project_id

# 存储模式 (true=本地存储, false=Firebase存储)
USE_LOCAL_STORAGE=true

# 端口配置
PORT=8080

# 部署环境 (true=Render环境, false=本地环境)
IS_RENDER=false
```

### **4. 启动特定机器人**

```bash
# 启动 my_bot_1
python main.py --bot my_bot_1

# 启动 my_bot_2
python main.py --bot my_bot_2
```

### **5. 查看可用机器人**

```bash
python main.py --list-bots
```

## 📁 文件结构

```
bybot3.0/
├── main.py                          # 主程序
├── multi_bot_config_manager.py      # 多机器人配置管理器
├── bot_configs/                     # 机器人配置目录
│   ├── my_bot_1.json               # 机器人1配置
│   ├── my_bot_2.json               # 机器人2配置
│   └── example_bot.json            # 示例配置
├── bot_session_my_bot_1.session    # 机器人1的session文件
├── bot_session_my_bot_2.session    # 机器人2的session文件
└── config.py                       # 默认配置（向后兼容）
```

## 🔧 高级配置

### **Session文件命名规则**

1. **优先使用配置中的session_name**
2. **基于Bot Token生成**: `bot_session_{token前8位}`
3. **回退到默认命名**: `bot_session` 或 `render_bot_session`

### **配置验证**

系统会自动验证以下字段：
- `bot_token`: 不能为空或占位符
- `api_id`: 不能为空或占位符  
- `api_hash`: 不能为空或占位符

### **存储模式**

每个机器人可以独立选择存储模式：
- `use_local_storage: true` - 使用本地存储
- `use_local_storage: false` - 使用Firebase存储

## 🚀 部署示例

### **本地部署多个机器人**

```bash
# 终端1: 启动机器人1
python main.py --bot my_bot_1

# 终端2: 启动机器人2  
python main.py --bot my_bot_2

# 终端3: 启动机器人3
python main.py --bot my_bot_3
```

### **Render部署**

为每个机器人创建独立的Render服务：

1. **机器人1服务**:
   - 环境变量: `BOT_NAME=my_bot_1`
   - 启动命令: `python main.py --bot my_bot_1`

2. **机器人2服务**:
   - 环境变量: `BOT_NAME=my_bot_2`  
   - 启动命令: `python main.py --bot my_bot_2`

## 🔍 故障排除

### **常见问题**

1. **"机器人配置无效或不存在"**
   - 检查配置文件是否存在
   - 验证配置文件格式是否正确
   - 确保所有必需字段都已填写

2. **"database is locked"**
   - 确保没有其他机器人实例在使用相同的session文件
   - 检查是否有僵尸进程占用session文件

3. **"配置验证失败"**
   - 检查bot_token、api_id、api_hash是否为实际值
   - 确保不是占位符值

### **调试命令**

```bash
# 列出所有配置
python main.py --list-bots

# 验证特定机器人配置
python -c "
from multi_bot_config_manager import multi_bot_manager
config = multi_bot_manager.load_bot_config('my_bot_1')
print('配置有效:', multi_bot_manager.validate_bot_config(config))
"
```

## 📝 最佳实践

1. **命名规范**: 使用有意义的机器人名称，如 `production_bot`、`test_bot`
2. **配置备份**: 定期备份 `bot_configs` 目录
3. **监控日志**: 为每个机器人设置独立的日志文件
4. **资源管理**: 监控每个机器人的资源使用情况
5. **安全考虑**: 确保配置文件权限设置正确

## 🔄 迁移现有机器人

如果您已有运行的机器人，可以这样迁移：

1. **备份现有配置**:
   ```bash
   cp .env bot_configs/old_bot.env
   ```

2. **创建新配置**:
   ```bash
   python main.py --create-bot old_bot
   ```

3. **复制配置值**:
   - 从 `.env` 复制实际值到新的JSON配置文件

4. **测试新配置**:
   ```bash
   python main.py --bot old_bot
   ```

5. **确认无误后删除旧配置**

## 🎯 总结

通过多机器人配置管理器，您可以：
- ✅ 在同一台服务器上运行多个机器人
- ✅ 每个机器人有独立的配置和session文件
- ✅ 避免配置冲突和数据混乱
- ✅ 支持灵活的部署和管理

现在您可以安全地部署多个机器人实例了！🚀
