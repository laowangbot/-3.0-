# 20ä¸ªé¢‘é“ç»„å¹¶å‘æ¬è¿é…ç½®å»ºè®®

## ğŸ¯ éœ€æ±‚åˆ†æ

æ‚¨å¸Œæœ›ä¸€æ¬¡æ€§é€‰æ‹©20ä¸ªé¢‘é“ç»„è¿›è¡ŒåŒæ—¶æ¬è¿ï¼Œè¿™éœ€è¦å¯¹å½“å‰ç³»ç»Ÿçš„å¹¶å‘é™åˆ¶è¿›è¡Œè°ƒæ•´ã€‚

## ğŸ“Š å½“å‰é™åˆ¶åˆ†æ

### ç°æœ‰é…ç½®
- **ç³»ç»Ÿæ€»å¹¶å‘é™åˆ¶**: 20ä¸ªä»»åŠ¡
- **ç”¨æˆ·å¹¶å‘é™åˆ¶**: 3ä¸ªä»»åŠ¡
- **é…ç½®ä½ç½®**: 
  - `config.py`: `max_concurrent_tasks = 10` (é»˜è®¤ç”¨æˆ·é…ç½®)
  - `cloning_engine.py`: `max_concurrent_tasks = 20` (å¼•æ“é…ç½®)
  - `cloning_engine.py`: ç”¨æˆ·é™åˆ¶ç¡¬ç¼–ç ä¸º3ä¸ª

### é™åˆ¶åŸå› 
1. **èµ„æºä¿æŠ¤**: é˜²æ­¢å•ä¸ªç”¨æˆ·å ç”¨è¿‡å¤šç³»ç»Ÿèµ„æº
2. **APIé™åˆ¶**: Telegram APIæœ‰é¢‘ç‡é™åˆ¶
3. **ç¨³å®šæ€§è€ƒè™‘**: é¿å…è¿‡å¤šå¹¶å‘å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š

## ğŸ”§ ä¿®æ”¹å»ºè®®

### æ–¹æ¡ˆä¸€ï¼šæå‡ç”¨æˆ·å¹¶å‘é™åˆ¶ï¼ˆæ¨èï¼‰

#### 1. ä¿®æ”¹ç”¨æˆ·å¹¶å‘é™åˆ¶

**æ–‡ä»¶**: `cloning_engine.py` (ç¬¬404è¡Œ)

```python
# åŸä»£ç 
if len(user_active_tasks) >= 3:
    logger.warning(f"ç”¨æˆ· {user_id} å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶: 3")
    return False

# ä¿®æ”¹ä¸º
max_user_concurrent = 20  # æˆ–è€…ä»é…ç½®æ–‡ä»¶è¯»å–
if len(user_active_tasks) >= max_user_concurrent:
    logger.warning(f"ç”¨æˆ· {user_id} å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶: {max_user_concurrent}")
    return False
```

#### 2. æ·»åŠ é…ç½®é€‰é¡¹

**æ–‡ä»¶**: `config.py` (åœ¨DEFAULT_USER_CONFIGä¸­æ·»åŠ )

```python
# ä»»åŠ¡è®¾ç½®
"max_concurrent_tasks": 10,  # æ”¯æŒæœ€å¤š10ä¸ªå¹¶å‘ä»»åŠ¡
"max_user_concurrent_tasks": 20,  # ç”¨æˆ·æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
"task_timeout": 3600,  # 1å°æ—¶
```

#### 3. åŠ¨æ€è¯»å–é…ç½®

**æ–‡ä»¶**: `cloning_engine.py` (ä¿®æ”¹start_cloningæ–¹æ³•)

```python
# æ£€æŸ¥ç”¨æˆ·å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶
user_id = task.config.get('user_id') if task.config else None
if user_id:
    # ä»ç”¨æˆ·é…ç½®è¯»å–é™åˆ¶
    user_config = await get_user_config(user_id)
    max_user_concurrent = user_config.get('max_user_concurrent_tasks', 20)
    
    user_active_tasks = [t for t in self.active_tasks.values() if t.config.get('user_id') == user_id]
    if len(user_active_tasks) >= max_user_concurrent:
        logger.warning(f"ç”¨æˆ· {user_id} å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶: {max_user_concurrent}")
        return False
```

### æ–¹æ¡ˆäºŒï¼šåˆ†æ‰¹æ‰§è¡Œï¼ˆä¿å®ˆæ–¹æ¡ˆï¼‰

å¦‚æœä¸æƒ³ä¿®æ”¹å¹¶å‘é™åˆ¶ï¼Œå¯ä»¥å®ç°æ™ºèƒ½åˆ†æ‰¹ï¼š

#### 1. ä¿®æ”¹å¤šä»»åŠ¡æ‰§è¡Œé€»è¾‘

**æ–‡ä»¶**: `main.py` (ä¿®æ”¹_execute_multi_cloningæ–¹æ³•)

```python
async def _execute_multi_cloning_batched(self, callback_query, user_id: str, task_configs: List[Dict]):
    """åˆ†æ‰¹æ‰§è¡Œå¤šä»»åŠ¡æ¬è¿"""
    batch_size = 3  # æ¯æ‰¹3ä¸ªä»»åŠ¡
    total_batches = (len(task_configs) + batch_size - 1) // batch_size
    
    for batch_num in range(total_batches):
        start_idx = batch_num * batch_size
        end_idx = min(start_idx + batch_size, len(task_configs))
        batch_configs = task_configs[start_idx:end_idx]
        
        await callback_query.message.reply_text(
            f"ğŸš€ å¼€å§‹æ‰§è¡Œç¬¬ {batch_num + 1}/{total_batches} æ‰¹ä»»åŠ¡ ({len(batch_configs)} ä¸ªé¢‘é“ç»„)"
        )
        
        # æ‰§è¡Œå½“å‰æ‰¹æ¬¡
        await self._execute_multi_cloning(callback_query, user_id, batch_configs)
        
        # ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆ
        if batch_num < total_batches - 1:
            await asyncio.sleep(5)  # æ‰¹æ¬¡é—´å»¶è¿Ÿ
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è°ƒæ•´æ¶ˆæ¯å¤„ç†å‚æ•°

```python
# config.py ä¸­çš„æ€§èƒ½è®¾ç½®
"message_delay": 0.5,  # å‡å°‘æ¶ˆæ¯é—´éš”ï¼ˆä»1.0ç§’é™åˆ°0.5ç§’ï¼‰
"batch_size": 20,      # å¢åŠ æ‰¹é‡å¤„ç†å¤§å°ï¼ˆä»10å¢åˆ°20ï¼‰
"retry_attempts": 2,   # å‡å°‘é‡è¯•æ¬¡æ•°ï¼ˆä»3é™åˆ°2ï¼‰
```

### 2. æ·»åŠ èµ„æºç›‘æ§

```python
import psutil

def check_system_resources():
    """æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ"""
    cpu_percent = psutil.cpu_percent()
    memory_percent = psutil.virtual_memory().percent
    
    if cpu_percent > 80 or memory_percent > 80:
        logger.warning(f"ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡è¿‡é«˜: CPU {cpu_percent}%, å†…å­˜ {memory_percent}%")
        return False
    return True
```

### 3. æ™ºèƒ½å»¶è¿Ÿè°ƒæ•´

```python
def calculate_dynamic_delay(active_tasks_count):
    """æ ¹æ®æ´»è·ƒä»»åŠ¡æ•°åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ"""
    base_delay = 0.5
    if active_tasks_count > 10:
        return base_delay * 1.5
    elif active_tasks_count > 5:
        return base_delay * 1.2
    return base_delay
```

## ğŸ›¡ï¸ é£é™©è¯„ä¼°ä¸é¢„é˜²

### æ½œåœ¨é£é™©
1. **APIé¢‘ç‡é™åˆ¶**: Telegramå¯èƒ½é™åˆ¶è¿‡äºé¢‘ç¹çš„è¯·æ±‚
2. **å†…å­˜æ¶ˆè€—**: 20ä¸ªå¹¶å‘ä»»åŠ¡ä¼šå¢åŠ å†…å­˜ä½¿ç”¨
3. **ç½‘ç»œè´Ÿè½½**: å¤§é‡å¹¶å‘å¯èƒ½å¯¼è‡´ç½‘ç»œæ‹¥å¡
4. **é”™è¯¯å¤„ç†**: æ›´å¤šä»»åŠ¡æ„å‘³ç€æ›´å¤šæ½œåœ¨é”™è¯¯ç‚¹

### é¢„é˜²æªæ–½
1. **æ¸è¿›å¼å¢åŠ **: å…ˆæµ‹è¯•5ä¸ªï¼Œå†10ä¸ªï¼Œå†15ä¸ªï¼Œæœ€å20ä¸ª
2. **ç›‘æ§å‘Šè­¦**: æ·»åŠ èµ„æºä½¿ç”¨ç›‘æ§
3. **è‡ªåŠ¨é™çº§**: æ£€æµ‹åˆ°é—®é¢˜æ—¶è‡ªåŠ¨å‡å°‘å¹¶å‘æ•°
4. **é”™è¯¯éš”ç¦»**: ç¡®ä¿å•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡

## ğŸ“ å®æ–½æ­¥éª¤

### ç«‹å³å¯è¡Œçš„ä¿®æ”¹ï¼ˆæ¨èï¼‰

1. **ä¿®æ”¹ç”¨æˆ·å¹¶å‘é™åˆ¶**
   ```bash
   # ç¼–è¾‘ cloning_engine.py ç¬¬404è¡Œ
   if len(user_active_tasks) >= 20:  # æ”¹ä¸º20
   ```

2. **æµ‹è¯•éªŒè¯**
   - å…ˆæµ‹è¯•5ä¸ªé¢‘é“ç»„
   - å†æµ‹è¯•10ä¸ªé¢‘é“ç»„
   - æœ€åæµ‹è¯•20ä¸ªé¢‘é“ç»„

3. **ç›‘æ§è§‚å¯Ÿ**
   - è§‚å¯Ÿç³»ç»Ÿèµ„æºä½¿ç”¨
   - æ£€æŸ¥ä»»åŠ¡å®Œæˆç‡
   - ç›‘æ§é”™è¯¯æ—¥å¿—

### å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ

1. **æ·»åŠ é…ç½®é€‰é¡¹** (config.py)
2. **å®ç°åŠ¨æ€é…ç½®è¯»å–** (cloning_engine.py)
3. **æ·»åŠ èµ„æºç›‘æ§** (æ–°å¢monitoræ¨¡å—)
4. **å®ç°æ™ºèƒ½åˆ†æ‰¹** (main.py)
5. **æ·»åŠ æ€§èƒ½è°ƒä¼˜** (å…¨å±€ä¼˜åŒ–)

## ğŸ¯ æ¨èé…ç½®

å¯¹äº20ä¸ªé¢‘é“ç»„çš„éœ€æ±‚ï¼Œæ¨èä»¥ä¸‹é…ç½®ï¼š

```python
# config.py
DEFAULT_USER_CONFIG = {
    # ... å…¶ä»–é…ç½® ...
    "max_concurrent_tasks": 20,        # ç³»ç»Ÿæ€»é™åˆ¶
    "max_user_concurrent_tasks": 20,   # ç”¨æˆ·é™åˆ¶
    "message_delay": 0.5,              # æ¶ˆæ¯é—´éš”
    "batch_size": 20,                  # æ‰¹é‡å¤§å°
    "task_timeout": 7200,              # 2å°æ—¶è¶…æ—¶
}
```

è¿™ä¸ªé…ç½®åœ¨ä¿è¯ç¨³å®šæ€§çš„åŒæ—¶ï¼Œèƒ½å¤Ÿæ»¡è¶³æ‚¨20ä¸ªé¢‘é“ç»„åŒæ—¶æ¬è¿çš„éœ€æ±‚ã€‚

---

**æ³¨æ„**: å»ºè®®å…ˆè¿›è¡Œå°è§„æ¨¡æµ‹è¯•ï¼Œç¡®è®¤ç³»ç»Ÿç¨³å®šåå†è¿›è¡Œå¤§è§„æ¨¡éƒ¨ç½²ã€‚